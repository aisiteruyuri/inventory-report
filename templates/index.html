<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>일일재고현황표</title>
  <style>
    :root{
      --line:#222;
      --bg:#f4f6f8;
      --panel:#fff;
      --blue:#1e40ff;
      --orange:#d35400;
      --muted:#6b7280;
    }
    body{ margin:0; font-family:system-ui,"Noto Sans KR",sans-serif; background:var(--bg); }
    .wrap{ max-width:1200px; margin:22px auto 60px; padding:0 16px; }
    .card{ background:var(--panel); border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow:0 4px 14px rgba(0,0,0,.04); }
    .title{ text-align:center; font-weight:800; margin:6px 0 12px; }
    textarea{ width:100%; min-height:120px; border:1px solid #d1d5db; border-radius:10px; padding:12px; font-family:ui-monospace,Consolas,monospace; box-sizing:border-box; }
    .row{ display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
    button{ border:0; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; }
    .ok{ background:#22c55e; color:#fff; }
    .ghost{ background:#eef2ff; color:#1f2a60; }
    .hint{ margin-top:10px; color:var(--muted); font-size:13px; line-height:1.5; }

    h1{ margin:18px 0 10px; text-align:center; letter-spacing:.35em; font-weight:900; }

    .board{ margin-top:18px; background:#fff; border-radius:12px; border:1px solid #e5e7eb; padding:10px; overflow-x:auto; }
    svg{ display:block; margin:0 auto; }

    .node-circle{ fill:#fff; stroke:var(--line); stroke-width:2.5; }
    .slot-box{ fill:#fff; stroke:var(--line); stroke-width:2.5; rx:10; ry:10; }
    .pipe{ stroke:var(--line); stroke-width:5; fill:none; stroke-linecap:round; stroke-linejoin:round; }

    .t-blue{ fill:var(--blue); font-weight:900; }
    .t-orange{ fill:var(--orange); font-weight:900; }
    .t-qty{ fill:#111; font-weight:900; }
    .t-loc{ fill:#5a7d39; font-weight:900; }
    .t-id{ fill:var(--muted); font-weight:900; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">데이터 입력 (엑셀 복사/붙여넣기)</div>
      <textarea id="paste" spellcheck="false" placeholder="장치장  곡종  재고량
A101   WUR   1,600
A102   WCRS  1,700.557
..."></textarea>

      <div class="row">
        <button class="ok" id="apply">현황표 업데이트</button>
        <button class="ghost" id="demo">데모</button>

        <!-- 과제 6번 충족용: 엑셀 업로드(실무에선 숨겨도 됨) -->
        <input type="file" id="file" accept=".xlsx,.xls" />
        <button class="ghost" id="upload">엑셀 업로드</button>
      </div>

      <div class="hint">
        • 붙여넣기 데이터는 서버에서 Python으로 파싱 후 SVG에 반영됩니다.<br/>
        • 보안상 업로드 금지라면 “엑셀 업로드” 버튼은 숨기고(코드 주석/삭제) 붙여넣기만 쓰면 됩니다.
      </div>
    </div>

    <h1>일일재고현황표</h1>
    <div class="board">
      <svg id="svg" width="1100" height="520" viewBox="0 0 1100 520"></svg>
    </div>
  </div>

<script>
  // ===== 구조 정의 (이미지와 동일한 배치 컨셉) =====
  const NODE_IDS = [
    ["A101","A102","A103","A104","A105","A106"],
    ["A301","A302","A303","A304","A305","A306"],
    ["A501","A502","A503","A504","A505","A506"],
  ];
  const TOP_SLOTS = ["A201","A202","A203","A204","A205","A206","A207"];
  const BOT_SLOTS = ["A401","A402","A403","A404","A405","A406","A407"];

  // 상태(서버가 내려준 값으로 갱신)
  let state = { nodes:{}, slots:{} };

  const svg = document.getElementById("svg");
  const W=1100, H=520;
  const margin={x:80,y:70};
  const cols=6, rows=3;
  const nodeR=44;
  const gridW=W-margin.x*2;
  const gridH=360;
  const dx=gridW/(cols-1);
  const dy=gridH/(rows-1);

  const yTop=margin.y;
  const yMid=margin.y+dy;
  const yBot=margin.y+dy*2;

  const xAt=(c)=>margin.x+dx*c;
  const nodePos=(c,r)=>({x:xAt(c), y:margin.y+dy*r});

  function el(name, attrs={}){
    const e=document.createElementNS("http://www.w3.org/2000/svg", name);
    for (const [k,v] of Object.entries(attrs)) e.setAttribute(k, String(v));
    return e;
  }

  function draw(){
    svg.innerHTML="";

    // 외곽 프레임
    const frameX=margin.x-60;
    const frameY=margin.y-50;
    const frameW=gridW+120;
    const frameH=gridH+100;
    svg.appendChild(el("rect",{x:frameX,y:frameY,width:frameW,height:frameH,fill:"none",stroke:"#222","stroke-width":5}));

    // 중앙 가로 라인
    svg.appendChild(el("line",{x1:frameX,y1:yMid,x2:frameX+frameW,y2:yMid,class:"pipe"}));

    // 수평 연결
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols-1;c++){
        const p1=nodePos(c,r), p2=nodePos(c+1,r);
        svg.appendChild(el("line",{x1:p1.x+nodeR,y1:p1.y,x2:p2.x-nodeR,y2:p2.y,class:"pipe"}));
      }
    }
    // 수직 연결
    for(let c=0;c<cols;c++){
      const pT=nodePos(c,0), pM=nodePos(c,1), pB=nodePos(c,2);
      svg.appendChild(el("line",{x1:pT.x,y1:pT.y+nodeR,x2:pM.x,y2:pM.y-nodeR,class:"pipe"}));
      svg.appendChild(el("line",{x1:pM.x,y1:pM.y+nodeR,x2:pB.x,y2:pB.y-nodeR,class:"pipe"}));
    }

    // 슬롯(네모) 14개
    const slotW=110, slotH=56;
    function slotPos(idx, band){
      const sx=frameX+(frameW)*(idx/6);
      const y=(band==="top") ? (yTop+yMid)/2 : (yMid+yBot)/2;
      return {x:sx, y:y};
    }
    function drawSlot(id, idx, band){
      const p=slotPos(idx, band);
      const item=(state.slots?.[id]?.item || "").toUpperCase();
      const qty=(state.slots?.[id]?.qty ?? "");

      svg.appendChild(el("rect",{x:p.x-slotW/2,y:p.y-slotH/2,width:slotW,height:slotH,class:"slot-box"}));

      const t1=el("text",{x:p.x,y:p.y-10,"text-anchor":"middle",class:"t-orange","font-size":16});
      t1.textContent=item || "—";
      svg.appendChild(t1);

      const t2=el("text",{x:p.x,y:p.y+14,"text-anchor":"middle",class:"t-qty","font-size":20});
      t2.textContent=qty===""?"":qty;
      svg.appendChild(t2);

      const t3=el("text",{x:p.x,y:p.y+34,"text-anchor":"middle",class:"t-id","font-size":13});
      t3.textContent=id;
      svg.appendChild(t3);
    }
    TOP_SLOTS.forEach((id,i)=>drawSlot(id,i,"top"));
    BOT_SLOTS.forEach((id,i)=>drawSlot(id,i,"bot"));

    // 노드(원) 18개
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const id=NODE_IDS[r][c];
        const p=nodePos(c,r);
        const item=(state.nodes?.[id]?.item || "").toUpperCase();
        const qty=(state.nodes?.[id]?.qty ?? "");

        svg.appendChild(el("circle",{cx:p.x,cy:p.y,r:nodeR,class:"node-circle"}));

        const t1=el("text",{x:p.x,y:p.y-10,"text-anchor":"middle",class:"t-blue","font-size":16});
        t1.textContent=item || "—";
        svg.appendChild(t1);

        const t2=el("text",{x:p.x,y:p.y+14,"text-anchor":"middle",class:"t-qty","font-size":22});
        t2.textContent=qty===""?"":qty;
        svg.appendChild(t2);

        const t3=el("text",{x:p.x,y:p.y+34,"text-anchor":"middle",class:"t-loc","font-size":13});
        t3.textContent=id;
        svg.appendChild(t3);
      }
    }
  }

  async function applyPaste(){
    const text=document.getElementById("paste").value;
    const res=await fetch("/api/parse",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({text})
    });
    const data=await res.json();
    if(!res.ok){ alert(data.error || "파싱 실패"); return; }
    state=data;
    draw();
  }

  async function uploadExcel(){
    const f=document.getElementById("file").files[0];
    if(!f){ alert("엑셀 파일을 선택하세요"); return; }
    const fd=new FormData();
    fd.append("file", f);
    const res=await fetch("/api/upload",{ method:"POST", body: fd });
    const data=await res.json();
    if(!res.ok){ alert(data.error || "업로드 실패"); return; }
    state=data;
    draw();
  }

  document.getElementById("apply").addEventListener("click", applyPaste);
  document.getElementById("upload").addEventListener("click", uploadExcel);

  document.getElementById("demo").addEventListener("click", ()=>{
    document.getElementById("paste").value =
`장치장\t곡종\t재고량
A101\tWUR\t1,600
A102\tWCRS\t1,700.557
A103\tWASW\t1,360.392
A104\tWASWP\t1,403.039
A105\tWUR\t1,700.915
A106\tWNS\t1,637.684
A201\tWUSL9.0\t146
A202\tWUSH\t420
A203\tWUR\t420
A204\tWUR\t420
A205\tWUSH\t420
A206\tWUSL9.0\t419
A207\tWUR\t158
A301\tWUSH\t864
A302\tWUSH\t1,695
A303\tWUSH\t1,671
A304\tWUSH\t1,690
A305\tWNS\t1,697
A306\tWUR\t1,701
A401\tWCRS\t170
A402\tWUSH\t410
A403\tWUSH\t0
A404\tWNS\t419
A405\tWUSH\t0
A406\tWUSH\t0
A407\tWNS\t170
A501\tWUSH\t1,557
A502\tWNS\t1,703
A503\tWUSH\t1,645
A504\tWCRS\t956
A505\tWASWP\t1,696
A506\tWUR\t1,700`;
  });

  // 최초 렌더(빈 화면)
  state = { nodes:{}, slots:{} };
  draw();
</script>
</body>
</html>
